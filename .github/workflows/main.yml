name: Frontend CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_API_URL: http://194.163.148.34:8000/api/v1
      NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
      NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
      NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
      NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
      NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      NEXTAUTH_URL: https://property.infiniasync.com  # Change from rental to property
    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.13.1'
        cache: 'npm'

    - name: Install dependencies
      run: |
        # Try npm ci first, fallback to npm install if lock file is out of sync
        npm ci || npm install    

    - name: Run lint
      run: npm run lint

    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production

    - name: Check build output
      run: |
        if [ -d ".next" ]; then
          echo "✅ Build successful - .next directory created"
          ls -la .next/
        else
          echo "❌ Build failed - .next directory not found"
          exit 1
        fi

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 10m            # Increase SSH connection timeout (non-blocking)
        command_timeout: 60m    # Increase remote command timeout to handle builds
        script_stop: true       # Stop on first error for clarity
        script: |
          # Ensure Node.js is installed
          if ! command -v node &> /dev/null; then
            echo "Node.js not found, installing..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          node -v
          npm -v
          
          cd /var/www/infinia-pms/frontend
          
          git reset --hard HEAD
          git clean -fd
          rm -rf node_modules .next out
          rm -f pnpm-lock.yaml
          git stash || true
          git pull origin main
          
          npm ci || npm install
          
          git checkout .env.production
          cp .env.production .env.local
          
          NEXT_PUBLIC_API_URL=https://property.infiniasync.com/api/v1 \
          NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }} \
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }} \
          NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }} \
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }} \
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }} \
          NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }} \
          NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }} \
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }} \
          NEXTAUTH_URL=https://property.infiniasync.com \
          npm run build
          
          if [ ! -d ".next" ]; then
            echo "❌ Build failed - .next directory not found"
            exit 1
          fi
          if [ ! -f ".next/prerender-manifest.json" ]; then
            echo "❌ Build failed - prerender-manifest.json not found"
            exit 1
          fi
          echo "✅ Build successful - .next directory created with required files"
          ls -la .next/
          
          if ! command -v pm2 &> /dev/null; then
            echo "PM2 not found, installing..."
            sudo npm install -g pm2
          fi
          
          pm2 stop frontend || true
          pm2 stop infinia-frontend || true
          pm2 delete frontend || true
          pm2 delete infinia-frontend || true
          
          cat << EOF > ecosystem.config.js
          module.exports = {
            apps: [{
              name: 'infinia-frontend',
              script: 'npm',
              args: 'start -- -p 3000 -H 127.0.0.1',
              cwd: '/var/www/infinia-pms/frontend',
              exec_mode: 'fork',
              instances: 1,
              autorestart: true,
              watch: false,
              env: {
                NODE_ENV: 'production',
                NEXTAUTH_URL: 'https://property.infiniasync.com',
                NEXT_PUBLIC_API_URL: 'https://property.infiniasync.com/api/v1/',
                NEXTAUTH_SECRET: '${{ secrets.NEXTAUTH_SECRET }}',
                NEXT_PUBLIC_FIREBASE_API_KEY: '${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}',
                NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: '${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}',
                NEXT_PUBLIC_FIREBASE_PROJECT_ID: '${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}',
                NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: '${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}',
                NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: '${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}',
                NEXT_PUBLIC_FIREBASE_APP_ID: '${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}',
                NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: '${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}',
                NEXT_ENABLE_PWA: '1'
              }
            }]
          }
          EOF

          pm2 start ecosystem.config.js
          pm2 save
          pm2 status
          pm2 logs infinia-frontend --lines 20 --nostream || true  # Ensure logs command exits immediately